<!-- app/views/admin/form_templates/edit.html.erb -->

<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-9">

      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="fw-bold mb-1 text-primary">Editar Template</h1>
          <p class="text-muted">Gerencie os campos e informa√ß√µes deste template.</p>
        </div>
        <%= link_to 'Cancelar', admin_form_templates_path, class: 'btn btn-outline-secondary' %>
      </div>

      <!-- Main Form Card -->
      <div class="card shadow-sm border-0 rounded-4 mb-5">
        <div class="card-body p-4">

          <%= form_with(model: [:admin, @form_template], local: true) do |form| %>

            <!-- Errors -->
            <% if @form_template.errors.any? %>
              <div class="alert alert-danger rounded-3 py-3 px-4 mb-4">
                <h5 class="fw-bold mb-2">
                  <%= pluralize(@form_template.errors.count, "erro") %> encontrado(s):
                </h5>
                <ul class="mb-0">
                  <% @form_template.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <!-- Template Information -->
            <h4 class="fw-semibold text-primary mb-3">Informa√ß√µes do Template</h4>

            <div class="mb-4">
              <%= form.label :name, "Nome do Template", class: "form-label fw-semibold" %>
              <%= form.text_field :name, class: "form-control form-control-lg", placeholder: "Ex: Avalia√ß√£o Final" %>
            </div>

            <div class="mb-4">
              <%= form.label :description, "Descri√ß√£o", class: "form-label fw-semibold" %>
              <%= form.text_area :description, class: "form-control", rows: 3, placeholder: "Breve descri√ß√£o do prop√≥sito deste template..." %>
            </div>

            <hr class="my-4">

            <!-- Fields Section -->
            <h4 class="fw-semibold text-primary mb-3">Campos do Template</h4>

            <div id="fields-container" class="mb-4">
              <%= form.fields_for :form_template_fields do |field_form| %>
                <%= render 'form_template_field_form', f: field_form %>
              <% end %>
            </div>

            <!-- Add Field Button -->
            <div class="mb-4">
              <button type="button" class="btn btn-outline-primary btn-lg rounded-3" onclick="addField()">
                ‚ûï Adicionar Campo
              </button>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-3">
              <%= form.submit "Salvar Altera√ß√µes",
                  class: "btn btn-success btn-lg px-4 rounded-3" %>
              <%= link_to 'Cancelar',
                  admin_form_templates_path,
                  class: "btn btn-secondary btn-lg px-4 rounded-3" %>
            </div>

          <% end %>

        </div>
      </div>

    </div>
  </div>
</div>

<script>
function addField() {
  const container = document.getElementById('fields-container');
  const currentFieldCount = container.querySelectorAll('.field-item').length;
  const newIndex = currentFieldCount;
  const newId = new Date().getTime();

  const fieldHtml = `
    <div class="card field-item p-3 mb-3 shadow-sm">
      <div class="row">
        <div class="col-md-3 mb-3">
          <label class="form-label fw-semibold">Posi√ß√£o</label>
          <input class="form-control" 
                 min="1"
                 value="${newIndex + 1}"
                 name="form_template[form_template_fields_attributes][${newId}][position]"
                 type="number">
        </div>

        <div class="col-md-4 mb-3">
          <label class="form-label fw-semibold">Tipo de Campo</label>
          <select class="form-select"
                  name="form_template[form_template_fields_attributes][${newId}][field_type]">
            <option value="">Selecione</option>
            <option value="text">text</option>
            <option value="textarea">textarea</option>
            <option value="email">email</option>
            <option value="number">number</option>
            <option value="date">date</option>
            <option value="select">select</option>
            <option value="radio">radio</option>
            <option value="checkbox">checkbox</option>
          </select>
        </div>

        <div class="col-md-2 mb-3 d-flex align-items-end">
          <div class="form-check">
            <input class="form-check-input"
                   name="form_template[form_template_fields_attributes][${newId}][required]"
                   type="checkbox" value="1" id="required_${newId}">
            <label class="form-check-label" for="required_${newId}">
              Obrigat√≥rio?
            </label>
          </div>
        </div>

        <div class="col-md-3 mb-3 d-flex align-items-end">
          <button type="button" class="btn btn-sm btn-danger" onclick="this.closest('.field-item').remove()">
            üóëÔ∏è Deletar
          </button>
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">R√≥tulo do Campo</label>
        <input class="form-control" placeholder="Ex: Seu Nome"
               name="form_template[form_template_fields_attributes][${newId}][label]"
               type="text">
      </div>

      <div class="mb-3">
        <label class="form-label fw-semibold">Op√ß√µes (JSON)</label>
        <small class="text-muted d-block mb-1">S√≥ para select/radio/checkbox</small>
        <textarea class="form-control" rows="2"
                  placeholder='["Op√ß√£o 1", "Op√ß√£o 2"]'
                  name="form_template[form_template_fields_attributes][${newId}][options]">
        </textarea>
      </div>
    </div>
  `;

  container.insertAdjacentHTML('beforeend', fieldHtml);
}
</script>
