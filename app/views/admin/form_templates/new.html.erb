<!-- app/views/admin/form_templates/new.html.erb -->

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <h1 class="mb-4">Novo Template de Formulário</h1>

      <%= form_with(model: [:admin, @form_template], local: true, method: :post) do |form| %>
        
        <% if @form_template.errors.any? %>
          <div class="alert alert-danger">
            <h4><%= pluralize(@form_template.errors.count, "erro") %> encontrado:</h4>
            <ul>
              <% @form_template.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="mb-3">
          <%= form.label :name, "Nome do Template" %>
          <%= form.text_field :name, class: 'form-control', placeholder: 'Ex: Avaliação de Desempenho' %>
        </div>

        <div class="mb-3">
          <%= form.label :description, "Descrição" %>
          <%= form.text_area :description, class: 'form-control', rows: 4, placeholder: 'Descreva o propósito deste template...' %>
        </div>

        <h4 class="mt-4 mb-3">Campos</h4>
        <div id="fields-container">
          <%= form.fields_for :form_template_fields do |field_form| %>
            <%= render 'form_template_field_form', f: field_form %>
          <% end %>
        </div>

        <div class="mb-3">
          <button type="button" class="btn btn-sm btn-info" onclick="addField()">
            Adicionar Campo
          </button>
        </div>

        <div class="d-flex gap-2">
          <%= form.submit "Criar Template", class: 'btn btn-success' %>
          <%= link_to 'Cancelar', admin_form_templates_path, class: 'btn btn-secondary' %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
function addField() {
  const container = document.getElementById('fields-container');
  const newId = new Date().getTime();
  
  const fieldHtml = `
    <div class="card mb-3 field-item">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-2">
              <label class="form-label">Posição</label>
              <input class="form-control" min="1" name="form_template[form_template_fields_attributes][${newId}][position]" type="number">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-2">
              <label class="form-label">Tipo de Campo</label>
              <select class="form-select" name="form_template[form_template_fields_attributes][${newId}][field_type]">
                <option value="">Selecione um tipo</option>
                <option value="text">text</option>
                <option value="textarea">textarea</option>
                <option value="email">email</option>
                <option value="number">number</option>
                <option value="date">date</option>
                <option value="select">select</option>
                <option value="radio">radio</option>
                <option value="checkbox">checkbox</option>
              </select>
            </div>
          </div>
        </div>
        <div class="mb-2">
          <label class="form-label">Rótulo do Campo</label>
          <input class="form-control" placeholder="Ex: Seu Nome" name="form_template[form_template_fields_attributes][${newId}][label]" type="text">
        </div>
        <div class="mb-2">
          <label class="form-label">Opções (JSON - apenas para select/radio/checkbox)</label>
          <small class="text-muted d-block mb-1">Ex: ["Opção 1", "Opção 2"] - deixe em branco para outros tipos</small>
          <textarea class="form-control" placeholder='["Opção 1", "Opção 2"]' name="form_template[form_template_fields_attributes][${newId}][options]" rows="2"></textarea>
        </div>
        <div class="form-check">
          <input class="form-check-input" name="form_template[form_template_fields_attributes][${newId}][required]" type="checkbox" value="1" id="required_${newId}">
          <label class="form-check-label" for="required_${newId}">Campo obrigatório?</label>
        </div>
      </div>
    </div>
  `;
  
  container.insertAdjacentHTML('beforeend', fieldHtml);
}
</script>