<!-- app/views/student/forms/answer.html.erb -->

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1><%= @form.title %></h1>
      <p class="text-muted"><%= @form.klass.name %></p>
    </div>
    <%= link_to 'Voltar', root_path, class: 'btn btn-secondary' %>
  </div>

  <% if @form.description.present? %>
    <div class="alert alert-info">
      <strong>Instruções:</strong><br>
      <%= simple_format(@form.description) %>
    </div>
  <% end %>

  <% if @form.due_date.present? %>
    <div class="alert alert-warning">
      <strong>⏰ Prazo:</strong> <%= l(@form.due_date, format: :long) %>
    </div>
  <% end %>

  <% if @form_response.form_answers.empty? %>
    <div class="alert alert-danger">
      <strong>Erro:</strong> Não há campos para preencher neste formulário.
    </div>
  <% else %>
    <%= form_with(model: @form_response, local: true, url: submit_answer_student_form_path(@form), method: :post) do |form| %>
      
      <% if @form_response.errors.any? %>
        <div class="alert alert-danger">
          <h4><%= pluralize(@form_response.errors.count, "erro") %> encontrado:</h4>
          <ul>
            <% @form_response.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>

      <%= form.fields_for :form_answers do |answer_form| %>
        <% field = answer_form.object.form_template_field %>
        
        <div class="card mb-3">
          <div class="card-body">
            <label class="form-label">
              <strong><%= field.label %></strong>
              <% if field.required %>
                <span class="text-danger">*</span>
              <% end %>
            </label>

            <% case field.field_type %>
              <% when 'text' %>
                <%= answer_form.text_field :answer, class: 'form-control', placeholder: field.label %>
              
              <% when 'textarea' %>
                <%= answer_form.text_area :answer, class: 'form-control', rows: 4, placeholder: field.label %>
              
              <% when 'email' %>
                <%= answer_form.email_field :answer, class: 'form-control', placeholder: field.label %>
              
              <% when 'number' %>
                <%= answer_form.number_field :answer, class: 'form-control', placeholder: field.label %>
              
              <% when 'date' %>
                <%= answer_form.date_field :answer, class: 'form-control' %>
              
              <% when 'select' %>
                <% options = field.options.present? ? JSON.parse(field.options) : [] %>
                <%= answer_form.select :answer, 
                    options,
                    { prompt: 'Selecione uma opção' },
                    class: 'form-select' %>
              
              <% when 'radio' %>
                <% options = field.options.present? ? JSON.parse(field.options) : [] %>
                <div class="btn-group-vertical w-100">
                  <% options.each do |option| %>
                    <div class="form-check">
                      <%= answer_form.radio_button :answer, option, class: 'form-check-input' %>
                      <%= answer_form.label :answer, option, class: 'form-check-label' %>
                    </div>
                  <% end %>
                </div>
              
              <% when 'checkbox' %>
                <% options = field.options.present? ? JSON.parse(field.options) : [] %>
                <div>
                  <% options.each do |option| %>
                    <div class="form-check">
                      <%= answer_form.check_box :answer, { multiple: true }, option, nil, class: 'form-check-input' %>
                      <%= answer_form.label :answer, option, class: 'form-check-label' %>
                    </div>
                  <% end %>
                </div>
            <% end %>
          </div>
        </div>
      <% end %>

      <div class="d-flex gap-2 mt-4">
        <%= form.submit "Enviar Respostas", class: 'btn btn-success btn-lg' %>
        <%= link_to 'Cancelar', root_path, class: 'btn btn-secondary btn-lg' %>
      </div>
    <% end %>
  <% end %>
</div>
